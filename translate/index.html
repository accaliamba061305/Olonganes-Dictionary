<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Olonganes Translator</title>
  <style>
    :root {
      --bg: #ffffff;
      --text: #333;
      --primary: #2196F3;
      --accent: #4CAF50;
      --border: #ddd;
      --gray: #777;
      --error: #f44336;
      --suggestion-bg: #f0f0f0;
    }
    body.dark {
      --bg: #121212;
      --text: #e0e0e0;
      --primary: #64B5F6;
      --accent: #81C784;
      --border: #444;
      --gray: #aaa;
      --suggestion-bg: #333;
    }
    body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; min-height: 100vh; }
    header { background: var(--primary); color: white; padding: 15px; text-align: center; position: relative; }
    header h1 { margin: 0; font-size: 1.8em; }
    .back { position: absolute; left: 15px; top: 18px; color: white; text-decoration: none; font-weight: bold; }
    main { max-width: 900px; margin: 30px auto; padding: 0 20px; }
    .lang-select { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
    select, .swap-btn { padding: 10px 15px; font-size: 1em; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); cursor: pointer; }
    .swap-btn { background: var(--primary); color: white; border: none; font-size: 1.2em; }
    .input-wrapper { position: relative; margin-bottom: 10px; }
    textarea { width: 100%; height: 160px; padding: 15px; font-size: 1.1em; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); resize: vertical; box-sizing: border-box; }
    .clear-btn { position: absolute; right: 12px; top: 12px; background: none; border: none; color: var(--gray); font-size: 1.4em; cursor: pointer; display: none; }
    .clear-btn:hover { color: var(--error); }
    .char-count { position: absolute; bottom: 8px; right: 12px; font-size: 0.85em; color: var(--gray); }
    .suggestions { list-style: none; margin: 0; padding: 0; border: 1px solid var(--border); border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; background: var(--suggestion-bg); display: none; }
    .suggestions li { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border); }
    .suggestions li:hover, .suggestions li.selected { background: var(--primary); color: white; }
    .actions { display: flex; gap: 10px; justify-content: center; margin: 15px 0; }
    button { padding: 10px 20px; font-size: 1em; border: none; border-radius: 6px; cursor: pointer; transition: opacity 0.2s; }
    #copyBtn { background: var(--gray); color: white; }
    button:hover { opacity: 0.9; }
    #output { width: 100%; min-height: 160px; padding: 15px; font-size: 1.1em; border: 1px solid var(--border); border-radius: 8px; background: rgba(0,0,0,0.03); white-space: pre-wrap; word-wrap: break-word; }
    #loading { display: none; text-align: center; color: var(--primary); font-style: italic; margin: 10px 0; }
    .not-found { color: var(--error); font-weight: bold; }
  </style>
</head>
<body>
  <header>
    <h1>Olonganes Translator</h1>
    <a href="../" class="back">← Back to Dictionary</a>
  </header>
  <main>
    <div class="lang-select">
      <select id="fromLang">
        <option value="en">English</option>
        <option value="ol">Olonganes</option>
      </select>
      <button class="swap-btn" id="swapBtn">↔</button>
      <select id="toLang">
        <option value="ol">Olonganes</option>
        <option value="en">English</option>
      </select>
    </div>

    <div class="input-wrapper">
      <textarea id="input" placeholder="Nhập từ hoặc cụm từ cần dịch..."></textarea>
      <button class="clear-btn" id="clearBtn">×</button>
      <div class="char-count" id="charCount">0 / 5000</div>
      <ul class="suggestions" id="suggestions"></ul>
    </div>

    <div id="loading">Đang tra cứu...</div>

    <div id="output">Kết quả dịch sẽ hiện ở đây...</div>

    <div class="actions">
      <button id="copyBtn">Copy kết quả</button>
    </div>
  </main>

  <script>
    let dictionary = [];
    let debounceTimer;
    let selectedSuggestionIndex = -1;

    // Load dictionary
    fetch('../dictionary.json')
      .then(res => res.json())
      .then(data => {
        dictionary = data;
        console.log('Loaded', dictionary.length, 'entries');
      })
      .catch(err => {
        console.error(err);
        document.getElementById('output').innerHTML = '<span class="not-found">Không load được từ điển!</span>';
      });

    const input = document.getElementById('input');
    const output = document.getElementById('output');
    const fromLang = document.getElementById('fromLang');
    const toLang = document.getElementById('toLang');
    const swapBtn = document.getElementById('swapBtn');
    const clearBtn = document.getElementById('clearBtn');
    const copyBtn = document.getElementById('copyBtn');
    const charCount = document.getElementById('charCount');
    const loading = document.getElementById('loading');
    const suggestionsList = document.getElementById('suggestions');

    // Sync languages
    fromLang.addEventListener('change', () => toLang.value = fromLang.value === 'en' ? 'ol' : 'en');
    toLang.addEventListener('change', () => fromLang.value = toLang.value === 'en' ? 'ol' : 'en');

    // Swap
    swapBtn.addEventListener('click', () => [fromLang.value, toLang.value] = [toLang.value, fromLang.value]);

    // Show/hide clear button
    input.addEventListener('input', () => {
      clearBtn.style.display = input.value.trim() ? 'block' : 'none';
      charCount.textContent = `${input.value.length} / 5000`;
    });

    // Clear input
    clearBtn.addEventListener('click', () => {
      input.value = '';
      clearBtn.style.display = 'none';
      charCount.textContent = '0 / 5000';
      suggestionsList.style.display = 'none';
      translateAuto();
    });

    // Auto suggestions & auto translate on input
    input.addEventListener('input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        const query = input.value.trim().toLowerCase();
        if (query.length < 1) {
          suggestionsList.style.display = 'none';
          translateAuto();
          return;
        }

        // Suggestions: filter dictionary
        const suggestions = dictionary
          .filter(entry => {
            const source = (fromLang.value === 'en' ? entry.english : entry.olonganes || '').toLowerCase();
            return source.startsWith(query) || source.includes(' ' + query);
          })
          .slice(0, 8); // max 8 gợi ý

        suggestionsList.innerHTML = '';
        if (suggestions.length > 0) {
          suggestions.forEach((entry, idx) => {
            const li = document.createElement('li');
            const sourceWord = fromLang.value === 'en' ? entry.english : entry.olonganes;
            li.textContent = sourceWord;
            li.addEventListener('click', () => {
              input.value = sourceWord;
              suggestionsList.style.display = 'none';
              translateAuto();
            });
            suggestionsList.appendChild(li);
          });
          suggestionsList.style.display = 'block';
        } else {
          suggestionsList.style.display = 'none';
        }

        translateAuto();
      }, 400); // debounce 400ms
    });

    // Auto translate function
    function translateAuto() {
      const text = input.value.trim().toLowerCase();
      if (!text || dictionary.length === 0) {
        output.textContent = text ? 'Đang tra cứu...' : 'Kết quả dịch sẽ hiện ở đây...';
        return;
      }

      loading.style.display = 'block';
      output.textContent = '';

      // Simulate delay for feel
      setTimeout(() => {
        loading.style.display = 'none';

        const isEnToOl = fromLang.value === 'en';
        let results = [];

        dictionary.forEach(entry => {
          const source = (isEnToOl ? entry.english : entry.olonganes || '').toLowerCase();
          if (source === text || source.includes(text)) {
            let res = `**${isEnToOl ? entry.english : entry.olonganes}** → **${isEnToOl ? entry.olonganes : entry.english}**\n`;
            if (entry.part_of_speech) res += `Loại: ${entry.part_of_speech}\n`;
            if (entry.definition) res += `Định nghĩa: ${entry.definition}\n`;
            if (entry.synonyms) res += `Từ đồng nghĩa: ${entry.synonyms}\n`;
            if (entry.example) res += `Ví dụ: ${entry.example}\n`;
            results.push(res);
          }
        });

        if (results.length > 0) {
          output.innerHTML = results.join('\n---\n');
        } else {
          output.innerHTML = `<span class="not-found">Không tìm thấy "${text}" trong từ điển.</span>`;
        }
      }, 600);
    }

    // Copy
    copyBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(output.innerText).then(() => {
        copyBtn.textContent = 'Đã copy!';
        setTimeout(() => copyBtn.textContent = 'Copy kết quả', 2000);
      });
    });

    // Optional: Arrow keys to navigate suggestions (nâng cao, nếu muốn)
    input.addEventListener('keydown', e => {
      if (suggestionsList.style.display !== 'block') return;
      const items = suggestionsList.querySelectorAll('li');
      if (e.key === 'ArrowDown') {
        selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, items.length - 1);
        highlightSuggestion(items);
      } else if (e.key === 'ArrowUp') {
        selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
        highlightSuggestion(items);
      } else if (e.key === 'Enter' && selectedSuggestionIndex >= 0) {
        e.preventDefault();
        items[selectedSuggestionIndex].click();
      }
    });

    function highlightSuggestion(items) {
      items.forEach((li, i) => li.classList.toggle('selected', i === selectedSuggestionIndex));
    }
  </script>
</body>
</html>
